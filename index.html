    <script>
        // ==================== 📝 קובץ הגדרות מוטמע ====================
        // כל ההגדרות כאן - ערכי לפי הצורך!
        
        const CONFIG = {
            // 👩‍🏫 רשימת מורות
            teachers: [
                "אודליה אביבי",
                "אסמא אבו ואסל",
                "גל אורון",
                "איילת רוזנשטיין",
                "דדי הראל",
                "דפנה דייני",
                "איריס זוהר",
                "יוסי אלעזר",
                "שי כרמלי",
                "נעמה לביב",
                "לבנת שקד",
                "לימור לוי",
                "ליאור שלמה",
                "נעמה לסרי",
                "הילה מגד",
                "מור אלקבץ",
                "מורן עזורה",
                "מיסא אגבאריה",
                "הוד נוף",
                "נור גלבוע",
                "מיה סהר",
                "סיון כיאט",
                "ורד עטר",
                "יעל עינת",
                "ענת אנדרסון",
                "קרין פפר",
                "רותי דיבשי",
                "שני שבתאי",
                "טל שחר",
                "דנה שטרנאו",
                "דנה שייקוביץ",
                "שמרית אהרוני"
            ],

            // 🎓 רשימת כיתות
            classes: [
                "א'", "ב'", "ג'", "ד'", "ה'", "ו'"
            ],

            // ⏰ שעות זמינות
            timeSlots: [
                "08:00", "09:00", "09:50", "11:00", "12:00",
                "12:50", "13:30", "14:15", "15:00"
            ],

            // 🛒 עגלות ומחשבים
            carts: {
                cart1: {
                    name: "עגלה #1",
                    computerPrefix: "PC1",
                    computerCount: 24,
                    description: "CHROME BOOKS"
                },
                cart2: {
                    name: "עגלה #2",
                    computerPrefix: "PC2",
                    computerCount: 12,
                    description: "LENOVO"
                }
            },

            // 🔢 אפשרויות כמות מחשבים
            computerCountOptions: [
                { value: 1, label: "1 מחשב" },
                { value: 2, label: "2 מחשבים" },
                { value: 3, label: "3 מחשבים" },
                { value: 4, label: "4 מחשבים" },
                { value: 5, label: "5 מחשבים" },
                { value: 6, label: "6 מחשבים" },
                { value: 7, label: "7 מחשבים" },
                { value: 8, label: "8 מחשבים" },
                { value: 9, label: "9 מחשבים" },
                { value: 10, label: "10 מחשבים" },
                { value: 11, label: "11 מחשבים" },
                { value: 12, label: "12 מחשבים" },
                { value: 13, label: "13 מחשבים" },
                { value: 14, label: "14 מחשבים" },
                { value: 15, label: "15 מחשבים" },
                { value: 16, label: "16 מחשבים" },
                { value: 17, label: "17 מחשבים" },
                { value: 18, label: "18 מחשבים" },
                { value: 19, label: "19 מחשבים" },
                { value: 20, label: "20 מחשבים" },
                { value: 21, label: "21 מחשבים" },
                { value: 22, label: "22 מחשבים" },
                { value: 23, label: "23 מחשבים" },
                { value: 24, label: "24 מחשבים" },
                { value: 25, label: "25 מחשבים" },
                { value: 36, label: "כל המחשבים" }
            ]
        };

        // Firebase Configuration<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת השאלת מחשבים</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
            min-height: 90vh;
        }
        
        .header {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
        }
        
        .connection-status {
            position: absolute;
            top: 10px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .connection-status.connected {
            background: rgba(76, 175, 80, 0.8);
        }
        
        .connection-status.disconnected {
            background: rgba(244, 67, 54, 0.8);
        }
        
        .header h1 {
            font-size: 1.8em;
            margin-bottom: 8px;
        }
        
        .content {
            padding: 30px 25px;
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        .main-options {
            text-align: center;
            margin-top: 60px;
        }
        
        .main-options h2 {
            color: #333;
            margin-bottom: 40px;
            font-size: 1.6em;
        }
        
        .option-btn {
            width: 100%;
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
            border: none;
            padding: 25px;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .option-btn:hover {
            transform: translateY(-3px);
        }
        
        .option-btn.return {
            background: linear-gradient(45deg, #FF9800, #F57C00);
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .step {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 8px;
            font-weight: bold;
            position: relative;
        }
        
        .step.active {
            background: #4CAF50;
            color: white;
        }
        
        .step.completed {
            background: #2196F3;
            color: white;
        }
        
        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            left: 100%;
            top: 50%;
            width: 16px;
            height: 2px;
            background: #ddd;
            transform: translateY(-50%);
        }
        
        .step.completed:not(:last-child)::after {
            background: #4CAF50;
        }
        
        .screen-title {
            text-align: center;
            color: #333;
            font-size: 1.4em;
            margin-bottom: 30px;
            font-weight: bold;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 12px;
            font-size: 1em;
            background: white;
        }
        
        .form-group select:focus,
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        .computer-section {
            margin-top: 20px;
        }
        
        .computer-count-info {
            background: #e8f5e8;
            border: 1px solid #4CAF50;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
            color: #2e7d32;
        }
        
        .computer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }
        
        .computer-checkbox {
            display: none;
        }
        
        .computer-label {
            display: block;
            background: #f5f5f5;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 10px 5px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85em;
        }
        
        .computer-label:hover {
            background: #e3f2fd;
            border-color: #2196F3;
        }
        
        .computer-checkbox:checked + .computer-label {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .computer-checkbox:disabled + .computer-label {
            background: #ffcdd2;
            color: #999;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 40px;
        }
        
        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #757575, #616161);
            color: white;
        }
        
        .success-content {
            text-align: center;
            padding: 40px 20px;
        }
        
        .success-icon {
            font-size: 4em;
            color: #4CAF50;
            margin-bottom: 20px;
        }
        
        .success-content h2 {
            color: #4CAF50;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        
        .success-content p {
            color: #666;
            margin-bottom: 30px;
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-right: 4px solid #f44336;
        }

        .loans-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 15px;
        }

        .loan-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .loan-item:hover {
            background-color: #f5f5f5;
        }

        .loan-item.selected {
            background-color: #e3f2fd;
            border-left: 4px solid #2196F3;
        }

        .loan-header {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .loan-details {
            font-size: 0.9em;
            color: #666;
        }

        .no-loans {
            text-align: center;
            padding: 30px;
            color: #999;
            font-style: italic;
        }
        
        @media (max-width: 480px) {
            .container {
                margin: 5px;
                border-radius: 15px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .content {
                padding: 20px;
            }
            
            .computer-grid {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            }
            
            .connection-status {
                position: static;
                display: inline-block;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="connection-status" id="connectionStatus">🔄 מתחברת...</div>
            <h1>🖥️ מערכת השאלת מחשבים</h1>
            <p>ניהול פשוט ויעיל</p>
        </div>
        
        <div class="content">
            <!-- מסך ראשי -->
            <div id="mainScreen" class="screen active">
                <div class="main-options">
                    <h2>בחרי פעולה</h2>
                    <button class="option-btn" id="loanBtn">
                        📝 השאלת מחשבים
                    </button>
                    <button class="option-btn return" id="returnBtn">
                        ↩️ החזרת מחשבים
                    </button>
                </div>
            </div>
            
            <!-- מסך 1: פרטי מורה -->
            <div id="teacherScreen" class="screen">
                <div class="step-indicator">
                    <div class="step active">1</div>
                    <div class="step">2</div>
                    <div class="step">3</div>
                </div>
                
                <h2 class="screen-title">פרטי המורה</h2>
                
                <div class="form-group">
                    <label for="teacherName">שם המורה:</label>
                    <select id="teacherName" required>
                        <option value="">בחרי מורה...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="teacherClass">כיתה:</label>
                    <select id="teacherClass" required>
                        <option value="">בחרי כיתה...</option>
                    </select>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" id="backToMain1">חזרה</button>
                    <button class="btn btn-primary" id="nextToDate">הבאה</button>
                </div>
            </div>
            
            <!-- מסך 2: תאריך ושעה -->
            <div id="dateScreen" class="screen">
                <div class="step-indicator">
                    <div class="step completed">1</div>
                    <div class="step active">2</div>
                    <div class="step">3</div>
                </div>
                
                <h2 class="screen-title">תאריך ושעת השאלה</h2>
                
                <div class="form-group">
                    <label for="loanDate">תאריך השאלה:</label>
                    <input type="date" id="loanDate" required>
                </div>
                
                <div class="form-group">
                    <label for="loanTime">שעת השאלה:</label>
                    <select id="loanTime" required>
                        <option value="">בחרי שעה...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="computerCount">מספר מחשבים מבוקש:</label>
                    <select id="computerCount" required>
                        <option value="">בחרי כמות...</option>
                    </select>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" id="backToTeacher">חזרה</button>
                    <button class="btn btn-primary" id="nextToComputer">הבאה</button>
                </div>
            </div>
            
            <!-- מסך 3: בחירת מחשבים -->
            <div id="computerScreen" class="screen">
                <div class="step-indicator">
                    <div class="step completed">1</div>
                    <div class="step completed">2</div>
                    <div class="step active">3</div>
                </div>
                
                <h2 class="screen-title">בחירת מחשבים</h2>
                
                <div class="form-group">
                    <label for="cartSelect">עגלה:</label>
                    <select id="cartSelect" required>
                        <option value="">בחרי עגלה...</option>
                    </select>
                </div>
                
                <div class="computer-section" id="computerSection" style="display: none;">
                    <h4>בחרי מחשבים זמינים:</h4>
                    <div class="computer-count-info" id="computerCountInfo">
                        נבחרו: 0 מתוך <span id="requiredCount">0</span>
                    </div>
                    <div class="computer-grid" id="computerGrid"></div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" id="backToDate">חזרה</button>
                    <button class="btn btn-primary" id="submitLoan" disabled>שלחי</button>
                </div>
            </div>
            
            <!-- מסך החזרה - שלב 1: בחירת מורה -->
            <div id="returnTeacherScreen" class="screen">
                <div class="step-indicator">
                    <div class="step active">1</div>
                    <div class="step">2</div>
                </div>
                
                <h2 class="screen-title">החזרת מחשבים - בחירת מורה</h2>
                
                <div class="form-group">
                    <label for="returnTeacher">איזו מורה מחזירה מחשבים:</label>
                    <select id="returnTeacher" required>
                        <option value="">בחרי מורה...</option>
                    </select>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" id="backToMainFromReturn1">חזרה</button>
                    <button class="btn btn-primary" id="nextToReturnLoanSelect">הבאה</button>
                </div>
            </div>
            
            <!-- מסך החזרה - שלב 2: בחירת השאלה -->
            <div id="returnLoanSelectScreen" class="screen">
                <div class="step-indicator">
                    <div class="step completed">1</div>
                    <div class="step active">2</div>
                </div>
                
                <h2 class="screen-title">בחירת השאלה להחזרה</h2>
                
                <div class="form-group">
                    <label>השאלות פעילות של <span id="selectedTeacherName"></span>:</label>
                    <div class="loans-list" id="activeLoansList">
                        <div class="no-loans">טוענת השאלות...</div>
                    </div>
                </div>
                
                <div class="form-group" id="returnDetailsSection" style="display: none;">
                    <label for="returnDate">תאריך החזרה:</label>
                    <input type="date" id="returnDate" required>
                </div>
                
                <div class="form-group" id="returnTimeSection" style="display: none;">
                    <label for="returnTime">שעת החזרה:</label>
                    <select id="returnTime" required>
                        <option value="">בחרי שעה...</option>
                    </select>
                </div>
                
                <div class="form-group" id="returnNotesSection" style="display: none;">
                    <label for="returnNotes">הערות (אופציונלי):</label>
                    <textarea id="returnNotes" rows="3" placeholder="הערות נוספות..."></textarea>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" id="backToReturnTeacher">חזרה</button>
                    <button class="btn btn-primary" id="submitReturn" disabled>אשרי החזרה</button>
                </div>
            </div>
            
            <!-- מסך הצלחה -->
            <div id="successScreen" class="screen">
                <div class="success-content">
                    <div class="success-icon">✅</div>
                    <h2 id="successTitle">אושרה הבקשה!</h2>
                    <p id="successMessage">הבקשה נשלחה בהצלחה ונרשמה במערכת.</p>
                    <button class="btn btn-primary" id="backToMainSuccess">חזרה לתפריט הראשי</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDf8rGwU7ESEyHLE1L_Th-sAFKAeLmBCuQ",
            authDomain: "laptop-loan.firebaseapp.com",
            databaseURL: "https://laptop-loan-default-rtdb.firebaseio.com",
            projectId: "laptop-loan",
            storageBucket: "laptop-loan.firebasestorage.app",
            messagingSenderId: "332408448005",
            appId: "1:332408448005:web:fb8d89d59ffd0f240b286c"
        };

        // Global Variables
        let app, database;
        let isConnected = false;
        let systemData = {
            carts: {},
            loans: []
        };
        
        let currentLoan = {};
        let selectedComputers = [];
        let selectedLoanForReturn = null;
        
        // Initialize Configuration Data (fallback אם config.js לא נטען)
        const DEFAULT_CONFIG = {
            teachers: [
                "מרים כהן", "דני לוי", "שרה מזרחי", "אבי רוזן", "רחל גולן",
                "יוסי אבני", "נועה כרמי", "משה ברק", "תמר יוסף", "דוד גרין"
            ],
            classes: ["א'", "ב'", "ג'", "ד'", "ה'", "ו'", "ז'", "ח'", "ט'", "י'", "יא'", "יב'"],
            timeSlots: ["08:00", "09:00", "10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00"],
            computerCountOptions: [
                { value: 1, label: "1 מחשב" },
                { value: 2, label: "2 מחשבים" },
                { value: 3, label: "3 מחשבים" },
                { value: 4, label: "4 מחשבים" },
                { value: 5, label: "5 מחשבים" },
                { value: 10, label: "10 מחשבים" },
                { value: 15, label: "15 מחשבים" },
                { value: 20, label: "20 מחשבים" },
                { value: 25, label: "25 מחשבים" },
                { value: 30, label: "כל המחשבים" }
            ],
            carts: {
                cart1: { name: "עגלה #1", computerPrefix: "PC1", computerCount: 15 },
                cart2: { name: "עגלה #2", computerPrefix: "PC2", computerCount: 15 },
                cart3: { name: "עגלה #3", computerPrefix: "PC3", computerCount: 20 }
            }
        };

        // הגדרות ברירת מחדל (לא בשימוש כעת)
        const DEFAULT_CONFIG = CONFIG;

        // משתמש בהגדרות המוטמעות
        const config = CONFIG;
        
        console.log(`✅ נטענו ${CONFIG.teachers.length} מורות בהצלחה!`);
        console.log('📋 מורות במערכת:', CONFIG.teachers.slice(0, 5).join(', ') + '...');
        
        // Generate Computer List
        function generateComputerList(prefix, count) {
            const computers = [];
            for (let i = 1; i <= count; i++) {
                computers.push(`${prefix}-${i.toString().padStart(3, '0')}`);
            }
            return computers;
        }

        // Initialize Cart Data
        function initializeCartData() {
            const cartData = {};
            
            Object.keys(config.carts).forEach(cartId => {
                const cart = config.carts[cartId];
                cartData[cartId] = {
                    name: cart.name,
                    description: cart.description || '',
                    computers: generateComputerList(cart.computerPrefix, cart.computerCount)
                };
            });
            
            return cartData;
        }
        
        // Populate Select Options
        function populateSelectOptions() {
            // Teachers
            const teacherSelects = ['teacherName', 'returnTeacher'];
            teacherSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">בחרי מורה...</option>';
                    config.teachers.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher;
                        option.textContent = teacher;
                        select.appendChild(option);
                    });
                }
            });

            // Classes
            const classSelect = document.getElementById('teacherClass');
            if (classSelect) {
                classSelect.innerHTML = '<option value="">בחרי כיתה...</option>';
                config.classes.forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className;
                    classSelect.appendChild(option);
                });
            }

            // Time slots
            const timeSelects = ['loanTime', 'returnTime'];
            timeSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">בחרי שעה...</option>';
                    config.timeSlots.forEach(time => {
                        const option = document.createElement('option');
                        option.value = time;
                        option.textContent = time;
                        select.appendChild(option);
                    });
                }
            });

            // Computer count
            const computerCountSelect = document.getElementById('computerCount');
            if (computerCountSelect) {
                computerCountSelect.innerHTML = '<option value="">בחרי כמות...</option>';
                config.computerCountOptions.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option.value;
                    optionElement.textContent = option.label;
                    computerCountSelect.appendChild(optionElement);
                });
            }

            // Carts
            const cartSelect = document.getElementById('cartSelect');
            if (cartSelect) {
                cartSelect.innerHTML = '<option value="">בחרי עגלה...</option>';
                Object.keys(config.carts).forEach(cartId => {
                    const option = document.createElement('option');
                    option.value = cartId;
                    option.textContent = config.carts[cartId].name;
                    cartSelect.appendChild(option);
                });
            }
        }
        
        // Initialize Firebase
        function initFirebase() {
            try {
                if (typeof firebase !== 'undefined') {
                    firebase.initializeApp(firebaseConfig);
                    database = firebase.database();
                    
                    // Listen for connection status
                    const connectedRef = database.ref('.info/connected');
                    connectedRef.on('value', (snapshot) => {
                        isConnected = snapshot.val();
                        updateConnectionStatus(isConnected);
                        
                        if (isConnected) {
                            loadDataFromFirebase();
                            setupFirebaseListeners();
                        }
                    });
                    
                    console.log('✅ Firebase initialized successfully');
                    return true;
                } else {
                    throw new Error('Firebase SDK not loaded');
                }
            } catch (error) {
                console.error('❌ Firebase initialization failed:', error);
                updateConnectionStatus(false);
                return false;
            }
        }
        
        // Update Connection Status
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.textContent = '🟢 מחוברת לענן';
                statusElement.className = 'connection-status connected';
            } else {
                statusElement.textContent = '🔴 מנותקת';
                statusElement.className = 'connection-status disconnected';
            }
        }
        
        // Load Data from Firebase
        function loadDataFromFirebase() {
            if (!database) return;
            
            database.ref().once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        if (data.carts) {
                            systemData.carts = data.carts;
                        } else {
                            systemData.carts = initializeCartData();
                        }
                        if (data.loans) {
                            systemData.loans = Object.values(data.loans);
                        }
                        console.log('✅ Data loaded from Firebase');
                    } else {
                        // Initialize with default cart data if no data exists
                        systemData.carts = initializeCartData();
                        saveToFirebase();
                    }
                })
                .catch((error) => {
                    console.error('❌ Error loading data:', error);
                    systemData.carts = initializeCartData();
                });
        }
        
        // Setup Firebase Listeners
        function setupFirebaseListeners() {
            if (!database) return;
            
            // Listen for new loans
            database.ref('loans').on('child_added', (snapshot) => {
                const loan = snapshot.val();
                const existingIndex = systemData.loans.findIndex(l => l.id === loan.id);
                if (existingIndex === -1) {
                    systemData.loans.push(loan);
                    console.log('📥 New loan received from Firebase');
                }
            });

            // Listen for loan updates (returns)
            database.ref('loans').on('child_changed', (snapshot) => {
                const updatedLoan = snapshot.val();
                const existingIndex = systemData.loans.findIndex(l => l.id === updatedLoan.id);
                if (existingIndex !== -1) {
                    systemData.loans[existingIndex] = updatedLoan;
                    console.log('📥 Loan updated from Firebase');
                }
            });
        }
        
        // Save to Firebase
        function saveToFirebase() {
            if (!database || !isConnected) {
                console.log('⚠️ Firebase not available');
                return;
            }
            
            // Convert loans array to object
            const loansObject = {};
            systemData.loans.forEach(loan => {
                loansObject[loan.id] = loan;
            });
            
            database.ref().set({
                carts: systemData.carts,
                loans: loansObject
            }).then(() => {
                console.log('✅ Data saved to Firebase');
            }).catch((error) => {
                console.error('❌ Error saving data:', error);
            });
        }
        
        // Show Screen
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }
        
        // Show Error Message
        function showError(message) {
            const existingErrors = document.querySelectorAll('.error-message');
            existingErrors.forEach(error => error.remove());
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            
            const activeScreen = document.querySelector('.screen.active');
            activeScreen.insertBefore(errorDiv, activeScreen.firstChild);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 4000);
        }
        
        // Get Occupied Computers
        function getOccupiedComputers(cartId, date) {
            return systemData.loans
                .filter(loan => loan.cart === cartId && loan.loanDate === date && !loan.returned)
                .flatMap(loan => loan.computers || []);
        }

        // Get Active Loans for Teacher
        function getActiveLoansForTeacher(teacherName) {
            return systemData.loans.filter(loan => 
                loan.teacherName === teacherName && 
                !loan.returned && 
                loan.type !== 'return'
            );
        }
        
        // Update Available Computers
        function updateAvailableComputers() {
            const selectedCart = document.getElementById('cartSelect').value;
            const computerSection = document.getElementById('computerSection');
            const computerGrid = document.getElementById('computerGrid');
            
            if (!selectedCart) {
                computerSection.style.display = 'none';
                return;
            }
            
            computerSection.style.display = 'block';
            computerGrid.innerHTML = '';
            selectedComputers = [];
            
            const cartData = systemData.carts[selectedCart];
            const occupiedComputers = getOccupiedComputers(selectedCart, currentLoan.loanDate);
            
            if (cartData && cartData.computers) {
                cartData.computers.forEach(computer => {
                    const isOccupied = occupiedComputers.includes(computer);
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = computer;
                    checkbox.className = 'computer-checkbox';
                    checkbox.value = computer;
                    checkbox.disabled = isOccupied;
                    
                    const label = document.createElement('label');
                    label.htmlFor = computer;
                    label.className = 'computer-label';
                    label.textContent = computer;
                    
                    computerGrid.appendChild(checkbox);
                    computerGrid.appendChild(label);
                    
                    checkbox.addEventListener('change', updateSelectedComputers);
                });
            }
            
            updateSelectedCount();
        }
        
        // Update Selected Computers
        function updateSelectedComputers() {
            const checkboxes = document.querySelectorAll('.computer-checkbox:checked');
            selectedComputers = Array.from(checkboxes).map(cb => cb.value);
            updateSelectedCount();
            updateSubmitButton();
        }
        
        // Update Selected Count
        function updateSelectedCount() {
            const selectedCount = selectedComputers.length;
            const requiredCount = currentLoan.computerCount || 0;
            
            document.getElementById('computerCountInfo').innerHTML = 
                `נבחרו: ${selectedCount} מתוך <span id="requiredCount">${requiredCount}</span>`;
        }
        
        // Update Submit Button
        function updateSubmitButton() {
            const submitBtn = document.getElementById('submitLoan');
            const selectedCount = selectedComputers.length;
            const requiredCount = currentLoan.computerCount || 0;
            
            submitBtn.disabled = selectedCount !== requiredCount;
        }

        // Load Active Loans for Return
        function loadActiveLoansForReturn(teacherName) {
            const activeLoans = getActiveLoansForTeacher(teacherName);
            const loansList = document.getElementById('activeLoansList');
            
            if (activeLoans.length === 0) {
                loansList.innerHTML = '<div class="no-loans">אין השאלות פעילות למורה זו</div>';
                return;
            }
            
            loansList.innerHTML = '';
            
            activeLoans.forEach(loan => {
                const loanItem = document.createElement('div');
                loanItem.className = 'loan-item';
                loanItem.setAttribute('data-loan-id', loan.id);
                
                const loanHeader = document.createElement('div');
                loanHeader.className = 'loan-header';
                loanHeader.textContent = `השאלה מתאריך ${loan.loanDate} - ${loan.loanTime}`;
                
                const loanDetails = document.createElement('div');
                loanDetails.className = 'loan-details';
                loanDetails.textContent = `כיתה ${loan.teacherClass} • ${loan.computers ? loan.computers.length : 0} מחשבים • ${systemData.carts[loan.cart]?.name || loan.cart}`;
                
                loanItem.appendChild(loanHeader);
                loanItem.appendChild(loanDetails);
                
                loanItem.addEventListener('click', () => selectLoanForReturn(loan, loanItem));
                
                loansList.appendChild(loanItem);
            });
        }

        // Select Loan for Return
        function selectLoanForReturn(loan, element) {
            // Remove previous selection
            document.querySelectorAll('.loan-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Select current item
            element.classList.add('selected');
            selectedLoanForReturn = loan;
            
            // Show return details sections
            document.getElementById('returnDetailsSection').style.display = 'block';
            document.getElementById('returnTimeSection').style.display = 'block';
            document.getElementById('returnNotesSection').style.display = 'block';
            
            // Enable submit button
            updateReturnSubmitButton();
        }

        // Update Return Submit Button
        function updateReturnSubmitButton() {
            const submitBtn = document.getElementById('submitReturn');
            const returnDate = document.getElementById('returnDate').value;
            const returnTime = document.getElementById('returnTime').value;
            
            submitBtn.disabled = !selectedLoanForReturn || !returnDate || !returnTime;
        }
        
        // Navigation Functions
        function goToDateScreen() {
            const teacherName = document.getElementById('teacherName').value;
            const teacherClass = document.getElementById('teacherClass').value;
            
            if (!teacherName || !teacherClass) {
                showError('אנא בחרי מורה וכיתה');
                return;
            }
            
            currentLoan.teacherName = teacherName;
            currentLoan.teacherClass = teacherClass;
            
            showScreen('dateScreen');
        }
        
        function goToComputerScreen() {
            const loanDate = document.getElementById('loanDate').value;
            const loanTime = document.getElementById('loanTime').value;
            const computerCount = document.getElementById('computerCount').value;
            
            if (!loanDate || !loanTime || !computerCount) {
                showError('אנא מלאי את כל השדות');
                return;
            }
            
            currentLoan.loanDate = loanDate;
            currentLoan.loanTime = loanTime;
            currentLoan.computerCount = parseInt(computerCount);
            
            showScreen('computerScreen');
        }

        function goToReturnLoanSelect() {
            const teacherName = document.getElementById('returnTeacher').value;
            
            if (!teacherName) {
                showError('אנא בחרי מורה');
                return;
            }
            
            document.getElementById('selectedTeacherName').textContent = teacherName;
            loadActiveLoansForReturn(teacherName);
            showScreen('returnLoanSelectScreen');
        }
        
        // Submit Loan
        function submitLoan() {
            const selectedCart = document.getElementById('cartSelect').value;
            
            if (!selectedCart || selectedComputers.length !== currentLoan.computerCount) {
                showError('אנא בחרי עגלה ומספר המחשבים הנדרש');
                return;
            }
            
            const newLoan = {
                id: Date.now(),
                ...currentLoan,
                cart: selectedCart,
                computers: [...selectedComputers],
                returned: false,
                createdAt: new Date().toISOString()
            };
            
            systemData.loans.push(newLoan);
            saveToFirebase();
            
            document.getElementById('successTitle').textContent = 'השאלה אושרה!';
            document.getElementById('successMessage').textContent = 'המחשבים הוקצו בהצלחה למורה.';
            showScreen('successScreen');
        }
        
        // Submit Return
        function submitReturn() {
            const returnDate = document.getElementById('returnDate').value;
            const returnTime = document.getElementById('returnTime').value;
            const returnNotes = document.getElementById('returnNotes').value;
            
            if (!selectedLoanForReturn || !returnDate || !returnTime) {
                showError('אנא בחרי השאלה ומלאי את כל השדות הנדרשים');
                return;
            }
            
            // Update the loan as returned
            const loanIndex = systemData.loans.findIndex(l => l.id === selectedLoanForReturn.id);
            if (loanIndex !== -1) {
                systemData.loans[loanIndex].returned = true;
                systemData.loans[loanIndex].returnDate = returnDate;
                systemData.loans[loanIndex].returnTime = returnTime;
                systemData.loans[loanIndex].returnNotes = returnNotes;
                systemData.loans[loanIndex].returnedAt = new Date().toISOString();
            }
            
            saveToFirebase();
            
            document.getElementById('successTitle').textContent = 'החזרה אושרה!';
            document.getElementById('successMessage').textContent = `המחשבים של ${selectedLoanForReturn.teacherName} הוחזרו בהצלחה למערכת.`;
            showScreen('successScreen');
            
            // Reset
            selectedLoanForReturn = null;
        }
        
        // Event Listeners
        function setupEventListeners() {
            // Main menu buttons
            document.getElementById('loanBtn').addEventListener('click', () => {
                showScreen('teacherScreen');
                currentLoan = {};
                selectedComputers = [];
            });
            
            document.getElementById('returnBtn').addEventListener('click', () => {
                showScreen('returnTeacherScreen');
                selectedLoanForReturn = null;
            });
            
            // Loan navigation buttons
            document.getElementById('backToMain1').addEventListener('click', () => showScreen('mainScreen'));
            document.getElementById('nextToDate').addEventListener('click', goToDateScreen);
            document.getElementById('backToTeacher').addEventListener('click', () => showScreen('teacherScreen'));
            document.getElementById('nextToComputer').addEventListener('click', goToComputerScreen);
            document.getElementById('backToDate').addEventListener('click', () => showScreen('dateScreen'));
            document.getElementById('submitLoan').addEventListener('click', submitLoan);
            
            // Return navigation buttons
            document.getElementById('backToMainFromReturn1').addEventListener('click', () => showScreen('mainScreen'));
            document.getElementById('nextToReturnLoanSelect').addEventListener('click', goToReturnLoanSelect);
            document.getElementById('backToReturnTeacher').addEventListener('click', () => showScreen('returnTeacherScreen'));
            document.getElementById('submitReturn').addEventListener('click', submitReturn);
            
            document.getElementById('backToMainSuccess').addEventListener('click', () => showScreen('mainScreen'));
            
            // Cart selection
            document.getElementById('cartSelect').addEventListener('change', updateAvailableComputers);
            
            // Return form change events
            document.getElementById('returnDate').addEventListener('change', updateReturnSubmitButton);
            document.getElementById('returnTime').addEventListener('change', updateReturnSubmitButton);
        }
        
        // Initialize System
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔄 מאתחלת מערכת...');
            
            // Populate select options from config
            populateSelectOptions();
            
            // Initialize cart data
            systemData.carts = initializeCartData();
            
            // Set default dates
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            const today = new Date().toISOString().split('T')[0];
            
            document.getElementById('loanDate').value = tomorrowStr;
            document.getElementById('returnDate').value = today;
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize Firebase
            initFirebase();
            
            console.log('✅ המערכת מוכנה לשימוש');
        });
    </script>
</body>
</html>